å¤ªæ£’äº†ï¼å®Œæˆäº†é˜¶æ®µä¸€ï¼Œæ„å‘³ç€ä½ å·²ç»èƒ½å¤Ÿåƒè°ƒç”¨æ™®é€š API ä¸€æ ·å’Œ LLM å¯¹è¯äº†ã€‚

**é˜¶æ®µäºŒï¼ˆThe Tool Registryï¼‰** æ˜¯ä»â€œèŠå¤©æœºå™¨äººâ€å‘â€œAgentâ€è¿›åŒ–çš„åˆ†æ°´å²­ã€‚è¿™é‡Œæˆ‘ä»¬è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼š**å¦‚ä½•æŠŠ Python å‡½æ•°ç¿»è¯‘æˆ LLM èƒ½çœ‹æ‡‚çš„ JSON å­—å…¸ã€‚**

æˆ‘ä»¬å°†ä»£ç æ‹†åˆ†ä¸ºä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼š**Schema è½¬æ¢å™¨** å’Œ **Agent ç±»æ³¨å†Œé€»è¾‘**ã€‚

å»ºè®®å°†ä»£ç åˆ†åˆ«æ”¾å…¥ `nano_agent/engine/tool.py` å’Œ `nano_agent/engine/agent.py`ï¼ˆå¦‚æœæš‚æ—¶ä¸æƒ³åˆ†æ–‡ä»¶ï¼Œå†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œä¹Ÿå¯ä»¥ï¼‰ã€‚

---

### ç¬¬ä¸€æ­¥ï¼šç¼–å†™ Schema è½¬æ¢å™¨ (`function_to_schema`)

è¿™æ˜¯æœ€â€œç¡¬æ ¸â€çš„éƒ¨åˆ†ã€‚æˆ‘ä»¬éœ€è¦åˆ©ç”¨ Python çš„ `inspect` æ ‡å‡†åº“æ¥è§£å‰–å‡½æ•°ã€‚

åœ¨ `nano_agent/engine/tool.py` ä¸­å†™å…¥ä»¥ä¸‹ä»£ç ï¼š

```python
import inspect
from typing import get_type_hints

def get_json_type(py_type):
    """
    å°† Python ç±»å‹æ˜ å°„ä¸º JSON Schema ç±»å‹
    """
    type_map = {
        str: "string",
        int: "integer",
        float: "number",
        bool: "boolean",
        list: "array",
        dict: "object",
        type(None): "null",
    }
    # å¦‚æœæ˜¯æ›´å¤æ‚çš„ç±»å‹ï¼ˆå¦‚ Optionalï¼‰ï¼Œè¿™é‡Œå¯ä»¥æ‰©å±•é€»è¾‘
    # ç®€å•èµ·è§ï¼Œå¦‚æœæ‰¾ä¸åˆ°æ˜ å°„ï¼Œé»˜è®¤å½“åš string å¤„ç†
    return type_map.get(py_type, "string")

def function_to_schema(func) -> dict:
    """
    æ ¸å¿ƒé­”æ³•ï¼šå°† Python å‡½æ•°è½¬æ¢ä¸º OpenAI Function JSON Schema
    """
    # 1. è·å–å‡½æ•°åå’Œæ–‡æ¡£
    name = func.__name__
    description = (func.__doc__ or "").strip()

    # 2. è§£æå‚æ•°
    sig = inspect.signature(func)
    type_hints = get_type_hints(func) # è·å–ç±»å‹æç¤º
    
    parameters = {
        "type": "object",
        "properties": {},
        "required": []
    }

    for param_name, param in sig.parameters.items():
        # è·³è¿‡ self å’Œ cls (å¦‚æœæ˜¯ç±»æ–¹æ³•)
        if param_name == 'self' or param_name == 'cls':
            continue

        # è·å–å‚æ•°ç±»å‹
        annotation = type_hints.get(param_name, str) # é»˜è®¤ä¸º str
        json_type = get_json_type(annotation)

        # æ„å»ºå‚æ•°æè¿°
        parameters["properties"][param_name] = {
            "type": json_type,
            "description": f"Parameter {param_name}" # å¯ä»¥åœ¨è¿™é‡Œåšæ›´å¤šä¼˜åŒ–ï¼Œè§£æ docstring è·å–å‚æ•°è¯´æ˜
        }

        # åˆ¤æ–­æ˜¯å¦ä¸ºå¿…å¡«é¡¹ (æ²¡æœ‰é»˜è®¤å€¼å°±æ˜¯å¿…å¡«)
        if param.default == inspect.Parameter.empty:
            parameters["required"].append(param_name)

    # 3. ç»„è£…æœ€ç»ˆç»“æ„
    schema = {
        "type": "function",
        "function": {
            "name": name,
            "description": description,
            "parameters": parameters,
        }
    }
    return schema
```

#### ğŸ’¡ ä»£ç è§£æï¼š
1.  **`inspect.signature`**: è¿™æ˜¯ Python çš„å†…çœç¥å™¨ï¼Œå®ƒèƒ½å‘Šè¯‰ä½ å‡½æ•°æœ‰å“ªäº›å‚æ•°ã€é»˜è®¤å€¼æ˜¯ä»€ä¹ˆã€‚
2.  **`get_type_hints`**: ä½ çš„é¡¹ç›®è¦æ±‚ Python 3.10+ å¼ºç±»å‹ï¼Œè¿™ä¸ªå‡½æ•°èƒ½æå– `def func(a: int)` é‡Œçš„ `int`ã€‚
3.  **Required é€»è¾‘**: å¦‚æœå‚æ•°æ²¡æœ‰é»˜è®¤å€¼ï¼ˆ`param.default == empty`ï¼‰ï¼Œåœ¨ JSON Schema é‡Œå®ƒå°±æ˜¯ `required`ï¼ŒLLM å¿…é¡»æä¾›ï¼›å¦‚æœæœ‰é»˜è®¤å€¼ï¼ŒLLM å¯ä»¥å¿½ç•¥ã€‚

---

### ç¬¬äºŒæ­¥ï¼šæ„å»º Agent ç±»ä¸æ³¨å†Œè£…é¥°å™¨

åœ¨ `nano_agent/engine/agent.py` ä¸­å»ºç«‹ Agent çš„é›å½¢ã€‚å®ƒéœ€è¦ä¸€ä¸ªå­—å…¸æ¥å­˜â€œçœŸèº«â€ï¼Œä¸€ä¸ªåˆ—è¡¨æ¥å­˜â€œå½±å­ï¼ˆSchemaï¼‰â€ã€‚

```python
from typing import Callable, List, Dict
# å‡è®¾ä¸Šé¢çš„ä»£ç åœ¨ tool.py ä¸­ï¼Œè¿™é‡Œå¯¼å…¥
from nano_agent.engine.tool import function_to_schema 
from nano_agent.core.llm import LLM # å‡è®¾ä½ é˜¶æ®µä¸€å†™çš„ LLM ç±»åœ¨è¿™é‡Œ

class Agent:
    def __init__(self, llm: LLM):
        self.llm = llm
        # æ ¸å¿ƒèµ„äº§ï¼š
        # 1. tool_map: å­˜å‡½æ•°æœ¬èº«ï¼Œç­‰åˆ°æ‰§è¡Œæ—¶è°ƒç”¨ -> {"get_weather": <func_obj>}
        self.tool_map: Dict[str, Callable] = {} 
        # 2. tool_schemas: å­˜æè¿°ï¼Œå‘ç»™ LLM çœ‹ -> [{"type": "function", ...}]
        self.tool_schemas: List[dict] = [] 

    def tool(self, func: Callable):
        """
        è£…é¥°å™¨ï¼šç”¨äºæ³¨å†Œå·¥å…·
        ä½¿ç”¨æ–¹æ³•ï¼š
        @agent.tool
        def my_func(...): ...
        """
        # 1. è§£æ Schema
        schema = function_to_schema(func)
        
        # 2. å­˜å…¥ Schema åˆ—è¡¨ (ç»™ LLM çœ‹çš„)
        self.tool_schemas.append(schema)
        
        # 3. å­˜å…¥å‡½æ•°å­—å…¸ (ç»™ Python æ‰§è¡Œç”¨çš„)
        self.tool_map[func.__name__] = func
        
        # 4. è£…é¥°å™¨åŸæ ·è¿”å›å‡½æ•°ï¼Œä¸å½±å“ Python åŸç”Ÿè°ƒç”¨
        return func
```

---

### ç¬¬ä¸‰æ­¥ï¼šé˜¶æ®µäºŒéªŒæ”¶ï¼ˆRun It!ï¼‰

åˆ›å»ºä¸€ä¸ª `test_phase_2.py` æ–‡ä»¶ï¼ŒæŠŠä¸Šé¢çš„é€»è¾‘ä¸²èµ·æ¥è·‘ä¸€ä¸‹ã€‚

```python
import json
# æ¨¡æ‹Ÿå¯¼å…¥ (å¦‚æœä½ è¿˜æ²¡æœ‰åˆ†æ–‡ä»¶ï¼Œç›´æ¥æŠŠä¸Šé¢çš„ä»£ç è´´åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œè¿è¡Œ)
# from nano_agent.engine.agent import Agent
# from nano_agent.core.llm import LLM

# 1. å®ä¾‹åŒ– (é˜¶æ®µä¸€çš„ LLM è¿™é‡Œæš‚æ—¶ä¸éœ€è¦çœŸå®è°ƒç”¨ï¼Œä¼ ä¸ª None æˆ–è€… Mock ä¹Ÿå¯ä»¥ï¼Œåªè¦ Agent ç±»èƒ½åˆå§‹åŒ–)
llm_mock = None 
agent = Agent(llm=llm_mock)

# 2. æ³¨å†Œå·¥å…·
@agent.tool
def get_weather(city: str, unit: str = "celsius"):
    """
    æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å¤©æ°”æƒ…å†µã€‚
    """
    return f"{city} is sunny, 25 {unit}"

@agent.tool
def calculator(a: int, b: int):
    """
    è®¡ç®—ä¸¤ä¸ªæ•°å­—çš„å’Œ
    """
    return a + b

# 3. éªŒè¯ç»“æœ
print(f"--- å·²æ³¨å†Œå·¥å…·æ•°é‡: {len(agent.tool_schemas)} ---")

print("\n[Schema Check: get_weather]")
# æ‰“å°å‡ºæ¥çš„ JSON åº”è¯¥éå¸¸æ¼‚äº®
print(json.dumps(agent.tool_schemas[0], indent=2, ensure_ascii=False))

print("\n[Func Map Check]")
print(f"Tool map keys: {agent.tool_map.keys()}")

# 4. éªŒè¯åŸç”Ÿè°ƒç”¨æ˜¯å¦å—å½±å“
print("\n[Execution Check]")
print(f"åŸç”Ÿè°ƒç”¨ç»“æœ: {get_weather('Beijing')}")
```

### é¢„æœŸè¾“å‡ºç»“æœ

å¦‚æœåœ¨æ§åˆ¶å°çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„ JSONï¼Œæ­å–œä½ ï¼Œä½ çš„ Agent å·²ç»æ‹¥æœ‰äº†â€œæ„ŸçŸ¥â€å·¥å…·çš„èƒ½åŠ›ï¼

```json
{
  "type": "function",
  "function": {
    "name": "get_weather",
    "description": "æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å¤©æ°”æƒ…å†µã€‚",
    "parameters": {
      "type": "object",
      "properties": {
        "city": {
          "type": "string",
          "description": "Parameter city"
        },
        "unit": {
          "type": "string",
          "description": "Parameter unit"
        }
      },
      "required": [
        "city"
      ]
    }
  }
}
```
*æ³¨æ„ï¼š`unit` æœ‰é»˜è®¤å€¼ï¼Œæ‰€ä»¥å®ƒä¸åœ¨ `required` åˆ—è¡¨ä¸­ã€‚*

---

### ğŸ’¡ ä¸‹ä¸€æ­¥ï¼ˆé˜¶æ®µä¸‰é¢„å‘Šï¼‰

ç°åœ¨ `agent.tool_schemas` é‡Œå·²ç»æœ‰äº† LLM éœ€è¦çš„æ•°æ®ã€‚
ä¸‹ä¸€é˜¶æ®µï¼Œä½ éœ€è¦æŠŠè¿™ä¸ªåˆ—è¡¨ä¼ ç»™ `client.chat.completions.create` çš„ `tools` å‚æ•°ã€‚

**ä»Šæ—¥ä»»åŠ¡ï¼š** è·‘é€šä¸Šé¢çš„ä»£ç ï¼Œç¡®ä¿ç”Ÿæˆçš„ Schema æ²¡æœ‰ä»»ä½•è¯­æ³•é”™è¯¯ï¼Œå› ä¸º LLM å¯¹ JSON Schema çš„æ ¼å¼éå¸¸æ•æ„Ÿï¼Œå°‘ä¸ªæ‹¬å·æˆ–è€…ç±»å‹å†™é”™éƒ½ä¼šå¯¼è‡´æ¨¡å‹â€œå¹»è§‰â€æˆ–æŠ¥é”™ã€‚
